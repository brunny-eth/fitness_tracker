{% extends "base.html" %}

{% block content %}

<div class="section">
    <h2>{{ date }}</h2>
    <div style="color: {% if worked_out_today %}green{% else %}black{% endif %}">
        {% if worked_out_today %}
        <p>Worked out today!</p>
        {% else %}
        <p>No workout logged yet today</p>
        {% endif %}
    </div>
</div>

<div class="section">
    <h2>Log Workout</h2>
    <form id="workoutForm">
        <div class="workout-day-row">
            <div class="workout-day-label-select">
                <label for="workout_day">Workout Day:</label>
                <select id="workout_day" name="workout_day" onchange="updateExerciseOptions()">
                    <option value="">Select Workout Day</option>
                    {% for category in workout_categories %}
                        <option value="{{ category.name }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <p class="helper-text">Need a new workout category? <a href="/settings#workout-categories">Add one here</a></p>
        </div>
        <div id="exercises">
            <div class="exercise-entry">
                <h3>Exercise 1</h3>
                <label for="exercise1">Exercise:</label>
                <select id="exercise1" name="exercise1">
                    <option value="">Select Exercise</option>
                </select><br>
                
                <label for="weight1">Weight (lbs):</label>
                <input type="number" id="weight1" name="weight1" min="0"><br>
                
                <label for="sets1">Sets:</label>
                <input type="number" id="sets1" name="sets1" min="1"><br>
                
                <label for="reps1">Reps:</label>
                <input type="number" id="reps1" name="reps1" min="1">
            </div>
        </div>
        <button type="button" id="addExerciseBtn">Add Another Exercise</button>
        <button type="button" onclick="submitWorkout()">Log Workout</button>
    </form>
</div>

<div class="section">
    <h2>Recent Workouts</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Exercises</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for workout in workouts %}
            <tr>
                <td>{{ workout.date.strftime('%Y-%m-%d') }}</td>
                <td>{{ workout.type }}</td>
                <td>
                    {% for exercise in json.loads(workout.exercises) %}
                        <div class="workout-entry">
                            <strong>{{ exercise.name }}</strong><br>
                            {{ exercise.weight }}lbs × {{ exercise.sets }}×{{ exercise.reps }}
                        </div>
                    {% endfor %}
                </td>
                <td>
                    <button class="edit-btn" data-workout-id="{{ workout.id }}">Edit</button>
                    <button onclick="deleteWorkout({{ workout.id }})" class="delete-btn">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="editWorkoutModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
        <h3>Edit Workout</h3>
        <form id="editWorkoutForm">
            <input type="hidden" id="editWorkoutId">
            <div class="workout-day-row">
                <div class="workout-day-label-select">
                    <label for="editWorkoutType">Workout Type:</label>
                    <select id="editWorkoutType" required>
                        <option value="">Select Workout Type</option>
                        {% for category in workout_categories %}
                            <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="editExercises"></div>
            <button type="button" id="addEditExerciseBtn">Add Exercise</button>
            <div style="margin-top: 20px;">
                <button type="button" onclick="submitWorkoutEdit()">Save</button>
                <button type="button" onclick="closeEditWorkoutModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>

window.testEdit = function(id) {
    console.log('Edit clicked:', id);
    const modal = document.getElementById('editWorkoutModal');
    modal.style.display = 'block';
}

let exercisesByType = {};

fetch('/get_workout_categories')
    .then(response => response.json())
    .then(categories => {
        categories.forEach(category => {
            exercisesByType[category.name] = category.exercises; 
        });
        updateExerciseOptions();
    })
    .catch(error => console.error('Error loading categories:', error));

    let exerciseCount = 1;

function updateExerciseOptions() {
    const workoutType = document.getElementById('workout_day').value;
    
    fetch('/get_workout_categories')
        .then(response => response.json())
        .then(categories => {
            categories.forEach(category => {
                exercisesByType[category.name] = category.exercises;
            });
            
            const exercises = exercisesByType[workoutType] || [];
            
            if (workoutType) {
                fetch(`/get_last_workout/${workoutType}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('exercises').innerHTML = '';
                        if (data.exercises && data.exercises.length > 0) {
                            data.exercises.forEach((exercise, index) => {
                                addExercise(index + 1, exercise);
                            });
                            exerciseCount = data.exercises.length;
                        } else {
                            addExercise(1);
                            exerciseCount = 1;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching last workout:', error);
                        document.getElementById('exercises').innerHTML = '';
                        addExercise(1);
                        exerciseCount = 1;
                    });
            } else {
                document.getElementById('exercises').innerHTML = '';
                addExercise(1);
                exerciseCount = 1;
            }
        })
        .catch(error => {
            console.error('Error refreshing categories:', error);
        });
}

function addExercise(number, previousExercise = null) {
    const workoutType = document.getElementById('workout_day').value;
    const availableExercises = exercisesByType[workoutType] || [];
    
    const exerciseHtml = `
        <div class="exercise-entry">
            <h3>Exercise ${number}</h3>
            <label for="exercise${number}">Exercise:</label>
            <select id="exercise${number}" name="exercise${number}">
                <option value="">Select Exercise</option>
                ${availableExercises.map(exercise => 
                    `<option value="${exercise}" ${previousExercise && previousExercise.name === exercise ? 'selected' : ''}>${exercise}</option>`
                ).join('')}
            </select><br>
            
            <label for="weight${number}">Weight (lbs):</label>
            <input type="number" id="weight${number}" name="weight${number}" min="0" 
                value="${previousExercise ? previousExercise.weight : ''}" ><br>
            
            <label for="sets${number}">Sets:</label>
            <input type="number" id="sets${number}" name="sets${number}" min="1" 
                value="${previousExercise ? previousExercise.sets : ''}" ><br>
            
            <label for="reps${number}">Reps:</label>
            <input type="number" id="reps${number}" name="reps${number}" min="1" 
                value="${previousExercise ? previousExercise.reps : ''}" >
        </div>
    `;
    document.getElementById('exercises').insertAdjacentHTML('beforeend', exerciseHtml);
}

function submitWorkout() {
    const exercises = [];
    for (let i = 1; i <= exerciseCount; i++) {
        const exercise = document.getElementById(`exercise${i}`).value;
        const weight = document.getElementById(`weight${i}`).value;
        const sets = document.getElementById(`sets${i}`).value;
        const reps = document.getElementById(`reps${i}`).value;
        
        if (exercise && weight && sets && reps) {
            exercises.push({
                name: exercise,
                weight: weight,
                sets: sets,
                reps: reps
            });
        }
    }
    
    if (exercises.length === 0) {
        alert('Please fill in at least one exercise completely');
        return;
    }
    
    fetch('/log_workout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: document.getElementById('workout_day').value,
            exercises: exercises
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    });
}

function deleteWorkout(workoutId) {
    if (confirm('Are you sure you want to delete this workout?')) {
        fetch(`/delete_workout/${workoutId}`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                location.reload();
            }
        });
    }
}

function editWorkout(event, workoutId, workoutType, exercises) {  
    console.log('Edit workout clicked:', { workoutId, workoutType, exercises });
    
    if (event) {  
        event.preventDefault();
        event.stopPropagation();
    }
    
    const modal = document.getElementById('editWorkoutModal');
    modal.style.display = 'block';
    document.getElementById('editWorkoutId').value = workoutId;
    document.getElementById('editWorkoutType').value = workoutType;
    
    const exercisesDiv = document.getElementById('editExercises');
    exercisesDiv.innerHTML = '';
    exercises.forEach((exercise, index) => {
        addEditExercise(index + 1, exercise);
    });
}

function addEditExercise(number, exercise = null) {
    const workoutType = document.getElementById('editWorkoutType').value;
    const availableExercises = exercisesByType[workoutType] || [];
    
    const exerciseHtml = `
        <div class="exercise-entry">
            <h3>Exercise ${number}</h3>
            <label for="editExercise${number}">Exercise:</label>
            <select id="editExercise${number}" name="editExercise${number}">
                <option value="">Select Exercise</option>
                ${availableExercises.map(ex => 
                    `<option value="${ex}" ${exercise && exercise.name === ex ? 'selected' : ''}>${ex}</option>`
                ).join('')}
            </select><br>
            
            <label for="editWeight${number}">Weight (lbs):</label>
            <input type="number" id="editWeight${number}" name="editWeight${number}" min="0" 
                value="${exercise ? exercise.weight : ''}" required><br>
            
            <label for="editSets${number}">Sets:</label>
            <input type="number" id="editSets${number}" name="editSets${number}" min="1" 
                value="${exercise ? exercise.sets : ''}" required><br>
            
            <label for="editReps${number}">Reps:</label>
            <input type="number" id="editReps${number}" name="editReps${number}" min="1" 
                value="${exercise ? exercise.reps : ''}" required>
        </div>
    `;
    document.getElementById('editExercises').insertAdjacentHTML('beforeend', exerciseHtml);
}

function submitWorkoutEdit() {
    const workoutId = document.getElementById('editWorkoutId').value;
    const exercises = [];
    const exerciseEntries = document.getElementById('editExercises').getElementsByClassName('exercise-entry');
    
    for (let i = 0; i < exerciseEntries.length; i++) {
        const num = i + 1;
        const exercise = document.getElementById(`editExercise${num}`).value;
        const weight = document.getElementById(`editWeight${num}`).value;
        const sets = document.getElementById(`editSets${num}`).value;
        const reps = document.getElementById(`editReps${num}`).value;
        
        if (exercise && weight && sets && reps) {
            exercises.push({
                name: exercise,
                weight: weight,
                sets: sets,
                reps: reps
            });
        }
    }
    
    if (exercises.length === 0) {
        alert('Please fill in at least one exercise completely');
        return;
    }
    
    fetch(`/update_workout/${workoutId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: document.getElementById('editWorkoutType').value,
            exercises: exercises
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    });
}

function closeEditWorkoutModal() {
    document.getElementById('editWorkoutModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const editWorkoutType = document.getElementById('editWorkoutType');
    if (editWorkoutType) {
        editWorkoutType.addEventListener('change', function() {
            const exercisesDiv = document.getElementById('editExercises');
            const exerciseEntries = exercisesDiv.getElementsByClassName('exercise-entry');
            const exercises = [];
            
            for (let i = 0; i < exerciseEntries.length; i++) {
                const num = i + 1;
                exercises.push({
                    weight: document.getElementById(`editWeight${num}`).value,
                    sets: document.getElementById(`editSets${num}`).value,
                    reps: document.getElementById(`editReps${num}`).value
                });
            }
            
            exercisesDiv.innerHTML = '';
            exercises.forEach((exercise, index) => {
                addEditExercise(index + 1, exercise);
            });
        });
    }

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const workoutId = this.getAttribute('data-workout-id');
            testEdit(workoutId);
        });
    }); 

    const addExerciseBtn = document.getElementById('addExerciseBtn');
    if (addExerciseBtn) {
        addExerciseBtn.onclick = function() {
            exerciseCount++;
            addExercise(exerciseCount);
        };
    }

    const addEditExerciseBtn = document.getElementById('addEditExerciseBtn');
    if (addEditExerciseBtn) {
        addEditExerciseBtn.onclick = function() {
            const exerciseEntries = document.getElementById('editExercises').getElementsByClassName('exercise-entry');
            addEditExercise(exerciseEntries.length + 1);
        };
    }
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('editWorkoutModal');
    const editButtons = document.querySelectorAll('.edit-btn');
    
    if (!Array.from(editButtons).includes(event.target) && event.target === modal) {
        closeEditWorkoutModal();
    }
});

window.closeEditWorkoutModal = function() {
    document.getElementById('editWorkoutModal').style.display = 'none';
}

</script>

<style>

td {
    position: relative;
    z-index: 1;
}

.exercise-entry {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 5px;
}

.workout-entry {
    margin-bottom: 10px;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.workout-entry:last-child {
    border-bottom: none;
}

select, input {
    margin: 5px 0;
    padding: 5px;
    width: 200px;
}

button {
    margin: 10px 5px;
    padding: 8px 15px;
}

.delete-btn {
    background-color: #f5f5f5;  
    color: #666;  
    border: 1px solid #ddd;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.delete-btn:hover {
    background-color: #e0e0e0;  
    color: #333;  
}

.workout-controls-row {
    display: flex;
    align-items: center;
    gap: 20px;  
}

.workout-day-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.workout-day-label-select {
    display: flex;
    align-items: center;
    gap: 10px;
}

.helper-text {
    color: #666;
    font-size: 0.9em;
    margin: 0;
}

.helper-text a {
    color: #4a90e2;
    text-decoration: none;
}

.helper-text a:hover {
    text-decoration: underline;
}

@media (max-width: 640px) {
    table, thead, tbody, th, td, tr {
        display: block;
    }
    
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    
    tr {
        margin-bottom: 16px;
        border-bottom: 1px solid #eee;
    }
    
    td {
        position: relative;
        padding-left: 50%;
        border: none;
    }
    
    td:before {
        position: absolute;
        left: 12px;
        width: 45%;
        padding-right: 10px;
        font-weight: 500;
    }
    
    td:nth-of-type(1):before { content: "Date"; }
    td:nth-of-type(2):before { content: "Type"; }
    td:nth-of-type(3):before { content: "Exercises"; }
    td:nth-of-type(4):before { content: "Actions"; }
    
    .exercise-entry {
        padding: 12px;
    }
    
    .exercise-entry select,
    .exercise-entry input {
        width: 100%;
        margin: 8px 0;
        font-size: 16px;
        padding: 8px;
    }
    
    .workout-day-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .workout-day-label-select {
        width: 100%;
    }
    
    .workout-day-label-select select {
        width: 100%;
    }
    
    button {
        width: 100%;
        margin: 8px 0;
        min-height: 44px;
    }
    
    .delete-btn {
        width: auto;
        padding: 12px 24px;
    }
}

.workout-entry {
    padding: 8px 0;
}

select, input {
    box-sizing: border-box;
}

.edit-btn {
    background-color: #f5f5f5;
    color: #666;
    border: 1px solid #ddd;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    margin-right: 5px;
}

.edit-btn:hover {
    background-color: #e0e0e0;  
    color: #333;
}

.modal {
    z-index: 1000;
}

.modal-content {
    border-radius: 8px;
}

@media (max-width: 640px) {
    .modal-content {
        margin: 5% auto;
        width: 90%;
        max-width: none;
    }
    
    .modal-content input,
    .modal-content select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 16px;
    }
    
    .modal-content button {
        width: 100%;
        margin: 8px 0;
        padding: 12px;
        min-height: 44px;
    }
}
</style>
{% endblock %}