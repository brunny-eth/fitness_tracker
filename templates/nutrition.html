{% extends "base.html" %}
{% block content %}

<div class="section" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
    <h2>{{ date }}</h2>
    <div class="{{ 'goal-met' if total_protein >= goal_amount else 'goal-not-met' }}">
        <h3>Protein Progress: {{ total_protein }}g / {{ goal_amount }}g</h3>
        <p>{{ 'Daily goal reached' if total_protein >= goal_amount else 'Still working toward daily goal' }}</p>
    </div>
    <div style="color: black">  
        <h3>Calories: {{ total_calories }}</h3>
    </div>
    
    <div class="today-meals" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
        <h3>Today's Meals</h3>
        {% if entries %}
            {% for entry in entries %}
                <div class="meal-entry" style="margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #eee;">
                    {{ entry.meal_name or 'Manual entry' }} 
                    <span style="color: #666;">
                        ({{ entry.protein_amount }}g protein, {{ entry.calorie_amount }} cal)
                    </span>
                </div>
            {% endfor %}
        {% else %}
            <p>No meals logged today</p>
        {% endif %}
    </div>
</div>

<div class="section nutrition-controls" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
    <h2>Add Nutrition Entry</h2>
    <div style="margin-bottom: 15px;">  
        <label for="entry_type">Select Entry Type:</label>  
        <select id="entry_type" onchange="toggleEntryType()" value="{{ entry_type }}" style="width: 200px; padding: 5px;">  
            <option value="manual">Manual Entry</option>
            <option value="claude">Ask Claude</option>
            <option value="saved">Saved Meals</option>
        </select>
    </div>

    <!-- The input sections -->
    <div id="manual_input">
        <label for="amount">Enter nutrition directly:</label>
        <input type="number" step="0.1" id="protein_amount" name="protein_amount" placeholder="Protein (g)">
        <input type="number" id="calorie_amount" name="calorie_amount" placeholder="Calories">
        <button type="button" onclick="addNutrition()">Add</button>
    </div>

    <div id="claude_input" style="display: none;">
        <textarea 
            id="meal_description" 
            placeholder="Describe what you ate (e.g., '2 eggs with toast and a banana')"
            rows="3" 
            style="width: 100%; margin: 10px 0;"
        ></textarea>
        <button type="button" onclick="analyzeMeal()" id="analyze_button">Analyze Meal</button>
        <div id="analysis_result" style="margin-top: 10px;"></div>
    </div>

    <div id="saved_meals_input" style="display: none;">
        <div id="quick_add" class="saved-meals">
            <h3>Quick Add Saved Meals</h3>
            {% for meal in saved_meals %}
            <div class="meal-entry">
                <span>{{ meal.name }} ({{ meal.protein_per_serving }}g protein, {{ meal.calories_per_serving }} cal)</span>
                <button type="button" onclick="addSavedMeal({{ meal.id }})">Add</button>
            </div>
            {% endfor %}
        </div>

        <div id="add_new_meal" style="margin-top: 20px;">
            <h3>Add New Saved Meal</h3>
            <div>
                <label for="new_meal_name">Meal Name:</label>
                <input type="text" id="new_meal_name" name="new_meal_name">
            </div>
            <div>
                <label for="new_meal_protein">Protein per Serving (g):</label>
                <input type="number" step="0.1" id="new_meal_protein" name="new_meal_protein">
            </div>
            <div>
                <label for="new_meal_calories">Calories per Serving:</label>
                <input type="number" id="new_meal_calories" name="new_meal_calories">
            </div>
            <button type="button" onclick="saveMeal()" style="margin-top: 10px;">Save Meal</button>
        </div>
    </div>
    
    <p id="result"></p>
</div>

<style>
.section-header {
    cursor: pointer;
    user-select: none;
}

.section-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
}

.section-header:hover {
    background-color: #f9f9f9;
}

.meal-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.saved-meals {
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
}

#meal_description {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
}

button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}
</style>

<script>
function checkIngredient() {
    const ingredient = document.getElementById('ingredient').value;
    fetch('/add_nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ingredient: ingredient })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('result').textContent = data.error;
        } else {
            document.getElementById('result').textContent = data.message;
            document.getElementById('protein_amount').value = data.protein;
            document.getElementById('calorie_amount').value = data.calories;
        }
    });
}

function addNutrition() {
    const protein_amount = document.getElementById('protein_amount').value;
    const calorie_amount = document.getElementById('calorie_amount').value;
    fetch('/add_nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            protein_amount: protein_amount,
            calorie_amount: calorie_amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('result').textContent = data.error;
        } else {
            document.getElementById('result').textContent = data.message;
            location.reload();
        }
    });
}

function addSavedMeal(mealId) {
    fetch('/add_nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ saved_meal_id: mealId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('result').textContent = data.error;
        } else {
            location.reload();
        }
    });
}

function saveMeal() {
    const name = document.getElementById('new_meal_name').value;
    const protein = document.getElementById('new_meal_protein').value;
    const calories = document.getElementById('new_meal_calories').value;
    fetch('/saved_meals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            protein_per_serving: protein,
            calories_per_serving: calories
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('result').textContent = data.error;
        } else {
            location.reload();
        }
    });
}

function toggleEntryType() {
    const entryType = document.getElementById('entry_type').value;
    const claudeInput = document.getElementById('claude_input');
    const manualInput = document.getElementById('manual_input');
    const savedMealsInput = document.getElementById('saved_meals_input');
    
    claudeInput.style.display = 'none';
    manualInput.style.display = 'none';
    savedMealsInput.style.display = 'none';
    
    switch(entryType) {
        case 'claude':
            claudeInput.style.display = 'block';
            break;
        case 'saved':
            savedMealsInput.style.display = 'block';
            break;
        default: // 'manual'
            manualInput.style.display = 'block';
    }
    
    const url = new URL(window.location);
    url.searchParams.set('entry_type', entryType);
    window.history.pushState({}, '', url);
}

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const entryType = urlParams.get('entry_type') || 'manual';
    
    console.log('Page loaded, setting entry type to:', entryType);
    
    const selectElement = document.getElementById('entry_type');
    if (selectElement) {
        selectElement.value = entryType;
        toggleEntryType();
    }
});

function analyzeMeal() {
    const description = document.getElementById('meal_description').value;
    const button = document.getElementById('analyze_button');
    const result = document.getElementById('analysis_result');
    
    button.disabled = true;
    button.textContent = 'Analyzing...';
    
    fetch('/analyze_meal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ description: description })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            result.innerHTML = `<p style="color: red;">${data.error}</p>`;
        } else {
            const nutritionData = JSON.stringify(data.nutrition).replace(/"/g, '&quot;');
            
            let breakdownHtml = '<div style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">';
            breakdownHtml += '<h4>Breakdown:</h4>';
            data.nutrition.breakdown.forEach(item => {
                breakdownHtml += `<p>${item.item} (${item.portion}): ${item.protein}g protein, ${item.calories} calories</p>`;
            });
            breakdownHtml += `<p><strong>Total: ${data.nutrition.total.protein}g protein, ${data.nutrition.total.calories} calories</strong></p>`;
            breakdownHtml += `<div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="toggleManualEdit('${nutritionData}')">Edit Manually</button>
                <button onclick='postAnalyzedMeal(${nutritionData})'>Post Meal</button>
            </div>`;
            breakdownHtml += '</div>';
            
            result.innerHTML = breakdownHtml;
            
            document.getElementById('protein_amount').value = data.nutrition.total.protein;
            document.getElementById('calorie_amount').value = data.nutrition.total.calories;
        }
    })
    .catch(error => {
        result.innerHTML = '<p style="color: red;">Error connecting to server</p>';
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'Analyze Meal';
    });
}

function toggleManualEdit(nutritionData) {
    const manualInput = document.getElementById('manual_input');
    manualInput.style.display = 'block';
    
    const data = typeof nutritionData === 'string' ? JSON.parse(nutritionData) : nutritionData;
    
    document.getElementById('protein_amount').value = data.total.protein;
    document.getElementById('calorie_amount').value = data.total.calories;
}

function postAnalyzedMeal(nutritionData) {
    fetch('/add_nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            protein_amount: nutritionData.total.protein,
            calorie_amount: nutritionData.total.calories,
            meal_name: document.getElementById('meal_description').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('result').textContent = data.error;
        } else {
            const url = new URL(window.location);
            url.searchParams.set('entry_type', 'claude');
            window.location.href = url.toString();
        }
    });
}

window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const entryType = urlParams.get('entry_type') || 'manual';
    
    document.getElementById('entry_type').value = entryType;
    toggleEntryType();
}

</script>
{% endblock %}